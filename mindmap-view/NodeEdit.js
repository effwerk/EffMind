import N from"./NodeHistory.js";import g from"../common/NodeTextManager.js";import{debounce as V}from"../common/Utils.js";class I{constructor(e){this.mindmapView=e,this.nodeTextManager=new g({allowRepeatPaste:!1,maxHistory:50}),this.nodeHistory=new N,this.activeInput=null,this.finishEditingCallback=null}findNode(e,i=this.mindmapView.mindMapData){if(i.id===e)return i;if(i.children)for(const t of i.children){const d=this.findNode(e,t);if(d)return d}return null}findParent(e,i=this.mindmapView.mindMapData){if(!i.children)return null;for(const t of i.children){if(t.id===e)return i;const d=this.findParent(e,t);if(d)return d}return null}isDescendant(e,i){const t=this.findNode(i);return!t||!t.children?!1:!!this.findNode(e,t)}toggleNodeCollapse(e){const i=this.findNode(e);i&&(i._collapsed=!i._collapsed,this.mindmapView.updateMindmap())}_traverseAllNodes(e,i,t=0){e&&(i(e,t),e.children&&e.children.forEach(d=>this._traverseAllNodes(d,i,t+1)))}expand(e=0){const i=this.mindmapView.mindMapData;this._traverseAllNodes(i,(t,d)=>{t.children&&t.children.length>0&&(e<=0?t._collapsed=!1:t._collapsed=d>=e)}),i._collapsed=!1,this.mindmapView.updateMindmap()}collapse(e=0){const i=this.mindmapView.mindMapData;this._traverseAllNodes(i,(t,d)=>{d<e?t._collapsed=!1:t.children&&t.children.length>0&&(t._collapsed=!0)}),this.mindmapView.updateMindmap()}getCollapsedStates(){const e={},i=this.mindmapView.mindMapData;return this._traverseAllNodes(i,t=>{t.id&&(e[t.id]=!!t._collapsed)}),e}setCollapsedStates(e){if(!e)return;const i=this.mindmapView.mindMapData;this._traverseAllNodes(i,t=>{t.id&&e.hasOwnProperty(t.id)&&(t._collapsed=e[t.id])}),this.mindmapView.updateMindmap()}reparentDraggedNode(){if(this.mindmapView.interactionState.potentialParentId){const e=this.findParent(this.mindmapView.interactionState.draggedNodeId),i=this.findNode(this.mindmapView.interactionState.potentialParentId),t=this.findNode(this.mindmapView.interactionState.draggedNodeId);e&&i&&e.id!==i.id&&(e.children=e.children.filter(d=>d.id!==this.mindmapView.interactionState.draggedNodeId),i.children||(i.children=[]),i.children.push(t),this.mindmapView.updateMindmap(),this.mindmapView.dispatchMindmapNodeChange())}}addNode(){if(!this.mindmapView.selectedNodeId)return;const e=this.findNode(this.mindmapView.selectedNodeId);if(!e)return;const i={id:`node-${Date.now()}`,text:"",children:[]};e.children||(e.children=[]),e.children.push(i),this.mindmapView.selectedNodeId=i.id,this.mindmapView._nodeToFocus=this.mindmapView.selectedNodeId,this.mindmapView.isRootNodeModified=!0,this.mindmapView.updateMindmap()}addSibling(){if(!this.mindmapView.selectedNodeId||this.mindmapView.selectedNodeId==="root")return;const e=this.findParent(this.mindmapView.selectedNodeId);if(e){const i={id:`node-${Date.now()}`,text:"",children:[]},t=e.children.findIndex(d=>d.id===this.mindmapView.selectedNodeId);e.children.splice(t!==-1?t+1:e.children.length,0,i),this.mindmapView.selectedNodeId=i.id,this.mindmapView._nodeToFocus=this.mindmapView.selectedNodeId,this.mindmapView.updateMindmap()}}deleteSelectedNode(){if(!this.mindmapView.selectedNodeId||this.mindmapView.selectedNodeId==="root"||this.mindmapView.isTextEditing)return;const e=this.findParent(this.mindmapView.selectedNodeId);if(e){const i=e.children.findIndex(t=>t.id===this.mindmapView.selectedNodeId);e.children.splice(i,1),this.mindmapView.selectedNodeId=e.children.length>0?e.children[Math.min(i,e.children.length-1)].id:e.id,this.mindmapView._nodeToPan=this.mindmapView.selectedNodeId,this.mindmapView.updateMindmap()}this.mindmapView.interactionState={},window.removeEventListener("pointermove",this.mindmapView.interactionManager._boundHandlePointerMove),window.removeEventListener("pointerup",this.mindmapView.interactionManager._boundHandlePointerUp),window.removeEventListener("pointercancel",this.mindmapView.interactionManager._boundHandlePointerCancel)}undoNode(){const e=this.nodeHistory.undo();e&&(this.mindmapView.mindMapData=e.data,this.mindmapView.selectedNodeId=e.selectedNodeId,this.mindmapView.selectedNodeId&&(this.mindmapView._nodeToPan=this.mindmapView.selectedNodeId))}redoNode(){const e=this.nodeHistory.redo();e&&(this.mindmapView.mindMapData=e.data,this.mindmapView.selectedNodeId=e.selectedNodeId,this.mindmapView.selectedNodeId&&(this.mindmapView._nodeToPan=this.mindmapView.selectedNodeId))}copyNode(){if(this.mindmapView.selectedNodeId){const e=this.findNode(this.mindmapView.selectedNodeId);e&&(this.clipboard={type:"copy",data:JSON.parse(JSON.stringify(e))})}}cutNode(){if(this.mindmapView.selectedNodeId&&this.mindmapView.selectedNodeId!=="root"){const e=this.findNode(this.mindmapView.selectedNodeId);if(e){const i=this.findParent(this.mindmapView.selectedNodeId);if(i){this.clipboard={type:"cut",data:JSON.parse(JSON.stringify(e)),parentId:i.id};const t=i.children.findIndex(a=>a.id===this.mindmapView.selectedNodeId);i.children.splice(t,1);let d=i.id;i.children.length>0&&(d=i.children[t<i.children.length?t:i.children.length-1].id),this.mindmapView.selectedNodeId=d,this.mindmapView.updateMindmap(),this.mindmapView._nodeToPan=this.mindmapView.selectedNodeId}}}}pasteNode(){if(this.clipboard&&this.mindmapView.selectedNodeId){const e=this.findNode(this.mindmapView.selectedNodeId);if(e){const i=JSON.parse(JSON.stringify(this.clipboard.data)),t=d=>{d.id=`node-${Date.now()}-${Math.random().toString(36).slice(2,11)}`,d.children&&d.children.forEach(t)};t(i),e.children||(e.children=[]),e.children.push(i),this.clipboard.type==="cut"&&(this.clipboard=null),this.mindmapView.selectedNodeId=i.id,this.mindmapView.isRootNodeModified=!0,this.mindmapView.updateMindmap(),this.mindmapView._nodeToPan=this.mindmapView.selectedNodeId}}}finishEditing(e=!0){if(this.finishEditingCallback){const i=this.finishEditingCallback;this.finishEditingCallback=null,i(e)}}editNodeText(e,i){this.finishEditingCallback&&this.finishEditing(!1),this.mindmapView.isTextEditing=!0;const t=i.querySelector(".node-text"),d=i.querySelector(".node-rect");if(!t||!d){this.mindmapView.isTextEditing=!1;return}t.style.display="none";const a=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");a.setAttribute("x",-e.width/2),a.setAttribute("y",-e.height/2),a.setAttribute("width",e.width),a.setAttribute("height",e.height),a.classList.add("node-foreign-object");const n=document.createElement("input");n.id=`input-${e.id}`,n.className="node-text-div",n.value=e.text,n.style.whiteSpace="nowrap";const h=window.getComputedStyle(t);n.style.fontWeight=h.fontWeight,n.style.fontSize=h.fontSize,a.appendChild(n),i.appendChild(a),this.inputRectTracker||(this.inputRectTracker=new b(this.mindmapView.svg,150));const o=this.mindmapView.viewportManager.getPanForNode(this.mindmapView.selectedNodeId);n.hasNodeMoved=!1,n.addEventListener("focus",()=>{o&&this.inputRectTracker.start(()=>{n.getBoundingClientRect().y<20&&(n.hasNodeMoved=!0,this.mindmapView.viewportManager.panViewportToNode(this.mindmapView.selectedNodeId,o.x,Math.abs(this.mindmapView.svg.getBoundingClientRect().y)/2))}),this.mindmapView.dispatch("start-edit-node-text",{node:e})},{once:!0}),n.addEventListener("blur",()=>{o&&n.hasNodeMoved&&this.mindmapView.viewportManager.panViewportToNode(this.mindmapView.selectedNodeId,o.x,o.y),this.inputRectTracker.stop(),this.finishEditing(!0),this.mindmapView.dispatch("end-edit-node-text",{node:e})},{once:!0}),n.focus(),n.select(),this.activeInput=n;const r=()=>{const s=n.value;e.text=s.trim();const c=this.mindmapView.renderer.measureText(s||"M",e),u=c.width+2*this.mindmapView.NODE_PADDING_X,l=c.height+2*this.mindmapView.NODE_PADDING_Y;e.width=s.trim()?u:l,e.height=l,d.setAttribute("width",e.width),d.setAttribute("height",e.height),d.setAttribute("x",-e.width/2),d.setAttribute("y",-e.height/2),a.setAttribute("width",e.width),a.setAttribute("height",e.height),a.setAttribute("x",-e.width/2),a.setAttribute("y",-e.height/2);const m=i.querySelector(".toggle-circle");if(m&&m.setAttribute("cx",e.width/2),this.mindmapView.searchTerm){const p=s.toLowerCase().includes(this.mindmapView.searchTerm.toLowerCase());i.classList.toggle("highlight",p);const w=this.mindmapView.minimap?.shadowRoot.querySelector(`.minimap-node[data-id="${e.id}"]`);w&&w.classList.toggle("highlight",p)}this.mindmapView.layoutManager.autoLayout(this.mindmapView.mindMapData),this.mindmapView.renderer.updateNodePositions(),this.mindmapView.renderer.removeLinks(),this.mindmapView.renderer.renderLinks()};n.addEventListener("input",r),this.finishEditingCallback=(s=!0)=>{a.parentNode&&(e.text=n.value.trim(),n.removeEventListener("input",r),this.nodeTextManager.unbind(n),i.removeChild(a),t.style.display="",s&&(this.mindmapView.isRootNodeModified=!0,this.mindmapView.updateMindmap())),this.mindmapView.isTextEditing=!1,this.activeInput=null},n.addEventListener("keydown",s=>{s.key===" "||s.key==="Delete"||s.key==="Backspace"||s.key.startsWith("Arrow")?s.stopPropagation():s.key==="Enter"?(s.preventDefault(),s.stopPropagation(),this.finishEditing(!0)):s.key==="Escape"?(s.stopPropagation(),this.finishEditing(!0)):s.key==="Tab"&&(s.preventDefault(),s.stopPropagation(),this.finishEditing(!1),this.mindmapView.dispatch("add-child-node"))}),this.nodeTextManager.bind(n),r()}}class b{constructor(e,i={}){if(!e)throw new Error("Element must be provided");this.element=e,this.rafId=null,this.prevRect=null,this.debounceWait=i.debounceWait||100,this.debouncedCallback=null}start(e,i=null){if(this.rafId)return;if(typeof e!="function")throw new Error("Callback must be a function");this.debouncedCallback=V(e,i||this.debounceWait);const t=()=>{const d=this.element.getBoundingClientRect();(!this.prevRect||d.top!==this.prevRect.top||d.bottom!==this.prevRect.bottom)&&(this.debouncedCallback(d),this.prevRect={top:d.top,bottom:d.bottom}),this.rafId=requestAnimationFrame(t)};this.rafId=requestAnimationFrame(t)}stop(){this.rafId&&(cancelAnimationFrame(this.rafId),this.rafId=null,this.debouncedCallback?.cancel&&this.debouncedCallback.cancel())}}export{I as default};
