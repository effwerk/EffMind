class V{constructor(e){this.mindmapView=e,this._boundHandlePointerMove=this._handlePointerMove.bind(this),this._boundHandlePointerUp=this._handlePointerUp.bind(this),this._boundHandlePointerCancel=this._handlePointerCancel.bind(this)}setupEventListeners(){this.activePointers=new Map,this.lastTap=0,this.mindmapView.svg.addEventListener("pointerdown",this._handlePointerDown.bind(this)),this.mindmapView.svg.addEventListener("dblclick",this._handleDblClick.bind(this)),this.mindmapView.svg.addEventListener("wheel",this._handleWheel.bind(this)),this.mindmapView.svg.addEventListener("contextmenu",this._handleContextMenu.bind(this))}_handlePointerDown(e){if(this.mindmapView.isTextEditing)return;window.addEventListener("pointermove",this._boundHandlePointerMove),window.addEventListener("pointerup",this._boundHandlePointerUp),window.addEventListener("pointercancel",this._boundHandlePointerCancel),this.activePointers.set(e.pointerId,{x:e.clientX,y:e.clientY,pointerType:e.pointerType});const t=this.mindmapView.interactionState;t.captureTarget=e.target;try{e.target.setPointerCapture(e.pointerId)}catch{}if(e.pointerType==="touch"){const i=Date.now();if(i-this.lastTap<300){this._handleDblClick(e),this.lastTap=0;return}this.lastTap=i}if(this.activePointers.size===2){if(t.panning||t.draggedNodeId)return;t.panning=!1,t.draggedNodeId=null,t.pinch={};const i=Array.from(this.activePointers.values());t.pinch.startDist=Math.hypot(i[0].x-i[1].x,i[0].y-i[1].y),t.pinch.startScale=this.mindmapView.viewState.scale,t.pinch.startPan={x:this.mindmapView.viewState.panX,y:this.mindmapView.viewState.panY},t.pinch.startCenter={x:(i[0].x+i[1].x)/2,y:(i[0].y+i[1].y)/2};return}const a=e.target.closest(".node");if(t.startX=t.initialStartX=e.clientX,t.startY=t.initialStartY=e.clientY,this.mindmapView.viewportManager.stopAnimation(),a){const i=a.dataset.id;e.target.closest(".toggle-circle")?this.mindmapView.nodeEdit.toggleNodeCollapse(i):(t.draggedNodeId=i,t.originalMindMapData=JSON.parse(JSON.stringify(this.mindmapView.mindMapData)))}else t.previousSelectedNodeId=this.mindmapView.selectedNodeId,t.panning=!0,this.mindmapView.svg.style.cursor="grabbing"}_handlePointerMove(e){if(!this.activePointers.has(e.pointerId))return;const t=this.mindmapView.interactionState;if(this.activePointers.set(e.pointerId,{x:e.clientX,y:e.clientY,pointerType:e.pointerType}),this.activePointers.size===2&&t.pinch&&t.pinch.startCenter){const n=Array.from(this.activePointers.values()),m=Math.hypot(n[0].x-n[1].x,n[0].y-n[1].y),c={x:(n[0].x+n[1].x)/2,y:(n[0].y+n[1].y)/2};this.mindmapView.viewportManager.handlePinch(t.pinch.startDist,m,t.pinch.startScale,t.pinch.startPan,t.pinch.startCenter,c);return}const a=e.clientX-(t.startX||e.clientX),i=e.clientY-(t.startY||e.clientY);if(t.panning){this.mindmapView.viewState.panX+=a,this.mindmapView.viewState.panY+=i,this.mindmapView.viewportManager.updateView(),t.startX=e.clientX,t.startY=e.clientY;return}const d=t.draggedNodeId;if(!d)return;if(!t.dragging&&(Math.abs(a)>5||Math.abs(i)>5)){t.dragging=!0;const n=this.mindmapView.nodeEdit.findNode(d);if(!n)return;t.offsetX=(e.clientX-this.mindmapView.viewState.panX)/this.mindmapView.viewState.scale-n.x,t.offsetY=(e.clientY-this.mindmapView.viewState.panY)/this.mindmapView.viewState.scale-n.y}if(!t.dragging)return;const o=this.mindmapView.nodeEdit.findNode(d);if(!o)return;const p=this.mindmapView.g.querySelector(`.node[data-id="${d}"]`);p&&(p.style.display="none");const l=this.mindmapView.shadowRoot.elementFromPoint(e.clientX,e.clientY);p&&(p.style.display="");const h=l?.closest(".node")||null;if(t.potentialParentId=null,h){const n=h.dataset.id;n!==d&&!this.mindmapView.nodeEdit.isDescendant(n,d)&&(t.potentialParentId=n)}if(t.potentialParentId){o.x=(e.clientX-this.mindmapView.viewState.panX)/this.mindmapView.viewState.scale-t.offsetX,o.y=(e.clientY-this.mindmapView.viewState.panY)/this.mindmapView.viewState.scale-t.offsetY,this.mindmapView.renderer.render(),this.mindmapView.minimap?.requestUpdate(),t.reorder=!1;return}const r=this.mindmapView.nodeEdit.findParent(d);if(r&&r.children.length>1){const n=e.clientY,m=r.children.findIndex(s=>s.id===d),c=r.children.filter(s=>s.id!==d).map(s=>{const v=this.mindmapView.g.querySelector(`.node[data-id="${s.id}"]`);if(!v)return null;const f=v.getBoundingClientRect();return{id:s.id,y:f.top+f.height/2}}).filter(Boolean);let w=c.findIndex(s=>n<s.y);w===-1&&(w=c.length);const u=w<c.length?c[w].id:null;let g=u?r.children.findIndex(s=>s.id===u):r.children.length;if(m<g&&g--,g!==m){t.reorder=!0;const s=r.children.splice(m,1)[0];r.children.splice(g,0,s),this.mindmapView.updateMindmap(),this.mindmapView.dispatchMindmapNodeChange()}else t.reorder=!1}t.reorder||(o.x=(e.clientX-this.mindmapView.viewState.panX)/this.mindmapView.viewState.scale-t.offsetX,o.y=(e.clientY-this.mindmapView.viewState.panY)/this.mindmapView.viewState.scale-t.offsetY,this.mindmapView.renderer.render(),this.mindmapView.minimap?.requestUpdate())}_handlePointerUp(e){if(!this.activePointers.has(e.pointerId))return;this.activePointers.delete(e.pointerId);const t=this.mindmapView.interactionState,a=t.captureTarget;if(a)try{a.releasePointerCapture(e.pointerId)}catch{}if(this.activePointers.size===0){const i=e.clientX-(t.initialStartX||e.clientX),d=e.clientY-(t.initialStartY||e.clientY),o=Math.abs(i)<5&&Math.abs(d)<5,p=t.draggedNodeId;if(t.dragging&&p)this.mindmapView.nodeEdit.reparentDraggedNode(),this.mindmapView.updateMindmap();else if(o&&!t.pinch){const l=e.composedPath()[0]||e.target;this.mindmapView.selectedNodeId=l.closest(".node")?.dataset.id||null,this.mindmapView.dispatch("node-focus")}else t.panning&&t.previousSelectedNodeId&&(this.mindmapView.selectedNodeId=t.previousSelectedNodeId);this.mindmapView.svg.style.cursor="default",this.mindmapView.interactionState={},window.removeEventListener("pointermove",this._boundHandlePointerMove),window.removeEventListener("pointerup",this._boundHandlePointerUp),window.removeEventListener("pointercancel",this._boundHandlePointerCancel)}else this.activePointers.size<2&&(t.pinch=null)}_handlePointerCancel(e){if(!this.activePointers.has(e.pointerId))return;this.activePointers.delete(e.pointerId);const t=this.mindmapView.interactionState,a=t.captureTarget;if(a)try{a.releasePointerCapture(e.pointerId)}catch{}this.activePointers.size<2&&(t.pinch=null),this.activePointers.size===0&&(t.dragging&&t.originalMindMapData&&(this.mindmapView.mindMapData=t.originalMindMapData,this.mindmapView.updateMindmap()),this.mindmapView.interactionState={},this.mindmapView.svg.style.cursor="default",window.removeEventListener("pointermove",this._boundHandlePointerMove),window.removeEventListener("pointerup",this._boundHandlePointerUp),window.removeEventListener("pointercancel",this._boundHandlePointerCancel))}_handleDblClick(e){const t=this.mindmapView.nodeEdit.activeInput;if(t&&t.contains(e.target))return;t&&t.blur();const a=e.target.closest(".node");a&&Promise.resolve().then(()=>{this.mindmapView.nodeEdit.editNodeText(this.mindmapView.nodeEdit.findNode(a.dataset.id),a)})}_handleWheel(e){e.preventDefault();const{viewState:t,viewportManager:a,svg:i}=this.mindmapView;if(e.ctrlKey||e.metaKey){const o=e.deltaY<0?1:-1,p=Math.exp(o*.1),l=t.scale*p,h=i.getBoundingClientRect(),r=e.clientX-h.left,n=e.clientY-h.top;a.zoomAtPoint(l,r,n)}else a.stopAnimation(),t.panX-=e.deltaX,t.panY-=e.deltaY,a.updateView()}_handleContextMenu(e){if(this.mindmapView.interactionState.pinch||this.mindmapView.isTextEditing&&e.pointerType==="touch")return;e.preventDefault();const t=e.target.closest(".node")?.dataset.id||null;this.mindmapView.dispatch("mindmap-context-menu",{x:e.clientX,y:e.clientY,nodeId:t})}}export{V as default};
