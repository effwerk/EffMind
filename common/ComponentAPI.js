class a{#r=new WeakMap;#t=new Map;#n=new Map;#s=new WeakMap;#e={};#o=!1;#i=new WeakMap;#c=typeof FinalizationRegistry<"u"?new FinalizationRegistry(t=>{try{for(const e of t){const{apiName:n,wrapper:s}=e,r=this.#t.get(n);r&&(r.delete(s),r.size===0&&this.#t.delete(n))}}catch{}}):null;constructor({debug:t=!1}={}){this.#o=t}on(t,e,n,s){this.off(t,e,n);const r=async i=>{try{this.#o&&console.log(`[ComponentAPI] ${e} called`,i);const f=await n(i);i?.callback&&i.callback(f);try{this._notifyWatchers(e,{type:"value",value:f})}catch{}}catch(f){console.error(`[ComponentAPI] ${e} handler error:`,f)}};let c=this.#r.get(t);if(!c){c=new Set,this.#r.set(t,c);const i=t.disconnectedCallback?.bind(t);t.disconnectedCallback=()=>{this.cleanup(t),i?.()}}c.add({api:e,handler:r,origHandler:n});try{let i=this.#i.get(t);i||(i=[],this.#i.set(t,i),this.#c&&this.#c.register(t,i,t)),i.push({apiName:e,wrapper:r})}catch{}let o=this.#t.get(e);o||(o=new Set,this.#t.set(e,o)),o.add(r),this._notifyWatchers(e,{type:"registered"});const l=this.#e[e];if(l?.length){for(const i of l)clearTimeout(i.timer),r({...i.params,callback:i.resolve});this.#e[e]=[]}s&&Array.isArray(s)&&s.length>0&&this.observeProperty(t,e,s)}observeProperty(t,e,n){if(!Array.isArray(n)){console.error("[ComponentAPI] observeProperty expects an array of property names.");return}const s=this;for(const r of n)try{const c=Symbol.for(`ComponentAPI:prop:${e}:${r}`);if(t[c])continue;let o;try{const i=Object.getOwnPropertyDescriptor(t,r)||Object.getOwnPropertyDescriptor(Object.getPrototypeOf(t),r);i&&i.get?o=i.get.call(t):o=t[r]}catch{o=t[r]}let l=`__componentapi_${r}`;t[l]=o,Object.defineProperty(t,r,{configurable:!0,enumerable:!0,get(){return this[l]},set(i){const f=this[l];this[l]=i;try{f!==i&&s.publish(e,i)}catch{}}}),t[c]=!0}catch(c){console.error(`[ComponentAPI] Failed to observe property "${r}" on host.`,c)}}off(t,e,n){const s=this.#r.get(t);if(s){for(const r of[...s])if(r.api===e&&(!n||r.origHandler===n)){s.delete(r);const c=this.#t.get(e);c&&(c.delete(r.handler),c.size===0&&this.#t.delete(e)),this._notifyWatchers(e,{type:"unregistered"})}}}cleanup(t){const e=this.#r.get(t);if(e){for(const n of[...e]){const s=this.#t.get(n.api);s&&(s.delete(n.handler),s.size===0&&this.#t.delete(n.api))}e.clear(),this.#r.delete(t);try{this.#i.get(t)&&(this.#c&&this.#c.unregister(t),this.#i.delete(t))}catch{}try{this._notifyWatchers(null,{type:"cleanup",host:t})}catch{}}}watch(t,e,n){let s=this.#s.get(t);s||(s=new Map,this.#s.set(t,s));let r=s.get(e);r||(r=new Set,s.set(e,r)),r.add(n);let c=this.#n.get(e);c||(c=new Set,this.#n.set(e,c)),c.add(n);try{const o=this.#t.get(e);o&&o.size>0&&this.call(e).catch(()=>{})}catch{}}unwatch(t,e){const n=this.#s.get(t);if(!n)return;const s=r=>{const c=n.get(r);if(!c)return;const o=this.#n.get(r);if(o)for(const l of c)o.delete(l);n.delete(r)};if(e)s(e);else{for(const r of n.keys())s(r);this.#s.delete(t)}}publish(t,e){this._notifyWatchers(t,{type:"value",value:e})}_notifyWatchers(t,e){if(t){const n=this.#n.get(t);if(!n)return;for(const s of[...n])try{s(e)}catch(r){console.error("watcher error",r)}}else for(const[n,s]of this.#n.entries())for(const r of[...s])try{r(e)}catch(c){console.error("watcher error",c)}}call(t,e={},n=5e3){return new Promise((s,r)=>{const c=this.#t.get(t);if(c&&c.size>0){const[l]=c,i=setTimeout(()=>{r(new Error(`[ComponentAPI] ${t} call timed out after ${n}ms`))},n);try{l({...e,callback:f=>{clearTimeout(i),s(f)}})}catch(f){clearTimeout(i),r(f)}return}this.#e[t]||(this.#e[t]=[]);const o=setTimeout(()=>{const l=this.#e[t].findIndex(i=>i.resolve===s);l>=0&&(this.#e[t].splice(l,1),r(new Error(`[ComponentAPI] ${t} call timed out after ${n}ms`)))},n);this.#e[t].push({params:e,resolve:s,reject:r,timer:o})})}setDebug(t=!0){this.#o=t}}var u=new a({debug:!1});export{u as default};
