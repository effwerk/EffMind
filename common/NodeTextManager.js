class o{static memoryClipboard={text:null,lastActionWasCut:!1};constructor(t={}){const e={allowRepeatPaste:!1,maxHistory:50};this.options={...e,...t},this.nodes=new Map}bind(t){if(!t||this.nodes.has(t))return;const e={history:[t.value],redoStack:[],isComposing:!1,listeners:{}};this.nodes.set(t,e);const s=()=>{e.isComposing||this._pushHistory(t)},a=()=>{e.isComposing=!0},r=()=>{e.isComposing=!1,this._pushHistory(t)},n=i=>this._handleKeydown(i,t);t.addEventListener("input",s),t.addEventListener("compositionstart",a),t.addEventListener("compositionend",r),t.addEventListener("keydown",n),e.listeners={onInput:s,onCompositionStart:a,onCompositionEnd:r,onKeyDown:n}}unbind(t){const e=this.nodes.get(t);if(!e)return;const{onInput:s,onCompositionStart:a,onCompositionEnd:r,onKeyDown:n}=e.listeners;t.removeEventListener("input",s),t.removeEventListener("compositionstart",a),t.removeEventListener("compositionend",r),t.removeEventListener("keydown",n),this.nodes.delete(t)}_handleKeydown(t,e){if(t.ctrlKey||t.metaKey)switch(t.key.toLowerCase()){case"z":t.preventDefault(),t.stopPropagation(),t.shiftKey?this.redo(e):this.undo(e);break;case"y":t.preventDefault(),t.stopPropagation(),this.redo(e);break;case"c":t.preventDefault(),t.stopPropagation(),this.copy(e);break;case"x":t.preventDefault(),t.stopPropagation(),this.cut(e);break;case"v":t.preventDefault(),t.stopPropagation(),this.paste(e);break;case"a":t.preventDefault(),t.stopPropagation(),e.select();break}}_pushHistory(t){const e=this.nodes.get(t);if(!e)return;const s=t.value,a=e.history[e.history.length-1];s!==a&&(e.history.push(s),e.redoStack=[],e.history.length>this.options.maxHistory&&e.history.shift())}undo(t){const e=this.nodes.get(t);if(!e||e.history.length<=1)return;const s=e.history.pop();e.redoStack.push(s),t.value=e.history[e.history.length-1]||"",this._dispatchClipboardEvent(),this._dispatchInputEvent(t)}redo(t){const e=this.nodes.get(t);if(!e||!e.redoStack.length)return;const s=e.redoStack.pop();e.history.push(s),t.value=s,this._dispatchClipboardEvent(),this._dispatchInputEvent(t)}async copy(t){const e=t.value.substring(t.selectionStart,t.selectionEnd);o.memoryClipboard.text=e,o.memoryClipboard.lastActionWasCut=!1;try{await navigator.clipboard.writeText(e)}catch{}this._dispatchClipboardEvent()}async cut(t){const e=t.value.substring(t.selectionStart,t.selectionEnd);o.memoryClipboard.text=e,o.memoryClipboard.lastActionWasCut=!0;try{await navigator.clipboard.writeText(e)}catch{}t.setRangeText("",t.selectionStart,t.selectionEnd,"start"),this._pushHistory(t),this._dispatchClipboardEvent(),this._dispatchInputEvent(t)}async paste(t){let e=null;try{e=await navigator.clipboard.readText()}catch{e=o.memoryClipboard.text}e===null&&(e=o.memoryClipboard.text),e!==null&&(t.setRangeText(e,t.selectionStart,t.selectionEnd,"end"),this._pushHistory(t),o.memoryClipboard.lastActionWasCut&&!this.options.allowRepeatPaste&&(o.memoryClipboard.text=null,o.memoryClipboard.lastActionWasCut=!1),this._dispatchClipboardEvent(),this._dispatchInputEvent(t))}getHistoryState(t){const e=this.nodes.get(t);return e?{canUndo:e.history.length>1,canRedo:e.redoStack.length>0}:{canUndo:!1,canRedo:!1}}async canPaste(){try{if(await navigator.clipboard.readText())return!0}catch{}return o.memoryClipboard.text!==null}_dispatchClipboardEvent(){const t=new CustomEvent("clipboardchange",{detail:{memoryText:o.memoryClipboard.text,lastActionWasCut:o.memoryClipboard.lastActionWasCut}});document.dispatchEvent(t)}_dispatchInputEvent(t){t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0,composed:!0}))}}export{o as default};
